<!DOCTYPE html>
<html>
	<head>
		<title>My First Web Page</title>
		<link
		rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
	  />
	</head>
	<body>
		<audio id="30" src="rire/RIRE30.wav" hidden></audio>
		<audio id="60" src="rire/RIRE60.wav" hidden></audio>
		<audio id="40" src="rire/RIRE40.wav" hidden></audio>
		<audio id="70" src="rire/RIRE70.wav" hidden></audio>
		<audio id="90"	src="rire/RIRE90.wav" hidden></audio>
		<div id="gauge">
			<div id="laugh"></div>
			<div id="level"></div>
		</div>
		<!-- <p id="exemple">Bouge cette barre pour tester: 50%</p>
		<input type="range" min="0" max="100" value="50" oninput="tester(this.value)">
		<p id="data">My first paragraph.</p> -->
		<!-- <iframe src="https://twitch.tv/popout/rocketleague/poll" frameborder="0"></iframe> -->
		<script>
			let spawnInterval = 1000;
			let spawnActive = true;
			let pollOn = false;
			let audioOn = false;
			async function data(){
				let data = await fetch("https://justcors.com/l_nqyz9xf02ff/https://gql.twitch.tv/gql#origin=twilight", {
				"headers": {
					"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0",
					"Accept": "*/*",
					"Client-Id": "kimne78kx3ncx6brgo4mv6wki5h1ko",
					"Content-Type": "text/plain;charset=UTF-8",
					"Sec-Fetch-Mode": "no-cors",
				},
				"body": "[{\"operationName\":\"ViewablePollsPage\",\"variables\":{\"login\":\"potatozytb\"},\"extensions\":{\"persistedQuery\":{\"version\":1,\"sha256Hash\":\"7e7e8f94ff51089e98d3baa90e0c96734f8dc87d48f7a1a529f22e6d2684a086\"}}}]",
				"method": "POST"
				});
				return data.json();
			}
			function muteAllAudios(){
				let audios = document.getElementsByTagName("audio");
				for (let i = 0; i < audios.length; i++){
					audios[i].pause();
				}
			}
			function getRand(min, max){
				return Math.floor(Math.random() * (max - min + 1)) + min;
			}
			function playAudio(id){
				if (audioOn == false) return;
				document.getElementById(id).play();
			}
			function updateGauge(percent){
				let level = document.getElementById("level");
				level.style.height = `${percent}%`;
				switch (true) {
					case (percent < 40):
						muteAllAudios();
						spawnActive = false;
						playAudio("30");
						break;
					case (percent > 40	&& percent < 60):
						spawnActive = true;	
						muteAllAudios();
						spawnInterval = 5000;
						playAudio("40");
						break;
					case (percent > 60	&& percent < 70):
						spawnActive = true;
						spawnInterval = 2000;
						muteAllAudios();
						playAudio("60");
						break;
					case (percent > 70 && percent < 90):
						spawnActive = true;
						spawnInterval = 500;
						muteAllAudios();
						playAudio("70");
						break;
					case (percent > 90):
						spawnActive = true;
						spawnInterval = 150;
						muteAllAudios();
						playAudio("90");
						break;
				}
			}
			function tester(percent){
				let text = document.getElementById("exemple");
				text.innerHTML = `Bouge cette barre pour tester: ${percent}%`;
				updateGauge(percent);
			}
			function putGif(id, location){
				let newImage = document.createElement("img");
				let container = document.getElementById("laugh");
				newImage.src = `gifs/${id}.gif`;
				newImage.style.width = "100px";
				newImage.style.position = "absolute";
				newImage.style.left = `${location.x}px`;
				newImage.style.top = `${location.y}px`;
				newImage.style.zIndex = "1";
				newImage.classList.add("animate__animated", "animate__fadeOutDown", "animate__slow")
				container.appendChild(newImage);
				setTimeout(() => {
					container.removeChild(newImage);
				}, 1000);
			}
			function pollActivated(){
				pollOn = true;
				setTimeout(() => {
					audioOn = true;
					spawnActive = true;
				}, 10000);
			}
			for (let audio of document.getElementsByTagName("audio")){
				audio.volume = 0.5;
				audio.loop = true;
			}
			function spawner(){
				setTimeout(() => {
					spawner();
					if (spawnActive == false) return;
					putGif(getRand(1,16), {x: getRand(-250, 250), y: getRand(0, 400)});
				}, spawnInterval)
			}
			spawner();
			setInterval(() => {
				data().then(async (res) => {
					const element = document.getElementById("data");
					let data = res;
					console.log(data);
					let poll = data[0].data.channel.viewablePoll
					if (poll != null){
						if(pollOn == false) pollActivated();
						let text = `Poll: ${poll.title}, votes ${poll.totalVoters}\n1:${poll.choices[0].totalVoters}\n2:${poll.choices[1].totalVoters}`;
						element.innerHTML = text;
						let percent = poll.choices[0].totalVoters / poll.totalVoters * 100;
						updateGauge(percent);
					}
					else{
						element.innerHTML = "No poll";
						muteAllAudios();
						spawnActive = false;
						pollOn = false;
						audioOn = false;
					}
				});
			}, 1000)
		</script>
		<style>
			#gauge {
				width: 100px;
				height: 500px;
				/* border: 1px solid black; */
				background-color: #ff0054;
				position: relative;
				margin-left: 200px;
				margin-right: 200px;
			}
			#level {
				width: 100%;
				height: 50%;
				background-color: #04daff;
				position: absolute;
				bottom: 0;
			}
			#laugh {
				width: 100%;
				height: 100%;
				position: absolute;
				bottom: 0;
			}
			.emoji{
				position: absolute;
			}
		</style>
	</body>
</html>